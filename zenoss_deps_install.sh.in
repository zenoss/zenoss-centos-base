#!/bin/bash
set -e

virtualenv /opt/zenoss
virtualenv --relocatable /opt/zenoss
source /opt/zenoss/bin/activate

echo "Installing Zenoss Python dependencies..."
mkdir -p /tmp/pydeps
tar -x -f /tmp/%PYDEPS% --strip-components=1 -C /tmp/pydeps
pushd /tmp/pydeps
pip install --no-index --find-links=./wheelhouse -r ./requirements.txt wheel
cat patches/* | patch -d $(python -c "import pip, os.path; print os.path.dirname(pip.__path__[0])") -p0
popd

echo "Installing jsbuilder..."
unzip -d /tmp/JSBuilder /tmp/%JSBUILDER%
mkdir -p /opt/zenoss/share/java/sencha_jsbuilder-2
cp /tmp/JSBuilder/*.jar /opt/zenoss/share/java/sencha_jsbuilder-2
cp /tmp/JSBuilder/Readme.txt /opt/zenoss/share/java/sencha_jsbuilder-2

echo "Installing phantomjs..."
mkdir -p /tmp/phantomjs
tar -x -f /tmp/%PHANTOMJS% --strip-components=1 -C /tmp/phantomjs
cp /tmp/phantomjs/bin/phantomjs /opt/zenoss/bin

cat <<EOF>> /home/zenoss/.bashrc
export ZENHOME=/opt/zenoss
source /opt/zenoss/bin/activate
export PYTHONPATH=/opt/zenoss/lib/python
export PATH=/opt/zenoss/bin:/opt/zenoss/var/ext/bin:$PATH
EOF

echo "Deleting pyc and pyo files..."
find /opt/zenoss -name \*.py[co] -delete
