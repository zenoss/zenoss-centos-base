#!/bin/bash
set -e

virtualenv /opt/zenoss
virtualenv --relocatable /opt/zenoss
source /opt/zenoss/bin/activate

echo "Installing Zenoss Python dependencies..."
cd /tmp
wget -qO- http://zenpip.zenoss.eng/packages/%PYDEPS%.tar.gz | tar xz 
cd /tmp/%PYDEPS%/
pip install --no-index --find-links=./wheelhouse -r ./requirements.txt wheel
cat patches/* | patch -d $(python -c "import pip, os.path; print os.path.dirname(pip.__path__[0])") -p0

echo "Installing jsbuilder..."
cd /tmp
wget -q http://zenpip.zenoss.eng/packages/%JSBUILDER%.zip -O /tmp/JSBuilder.zip
unzip -d /tmp/JSBuilder JSBuilder.zip
mkdir -p /opt/zenoss/share/java/sencha_jsbuilder-2
cp /tmp/JSBuilder/*.jar /opt/zenoss/share/java/sencha_jsbuilder-2
cp /tmp/JSBuilder/Readme.txt /opt/zenoss/share/java/sencha_jsbuilder-2

echo "Installing phantomjs..."
cd /tmp
wget http://zenpip.zenoss.eng/packages/%PHANTOMJS%.tar.bz2
tar jxf phantomjs*tar.bz2
cp /tmp/phantomjs*/bin/phantomjs /opt/zenoss/bin

cat <<EOF>> /home/zenoss/.bashrc
export ZENHOME=/opt/zenoss
source /opt/zenoss/bin/activate
export PYTHONPATH=/opt/zenoss/lib/python
export PATH=/opt/zenoss/bin:/opt/zenoss/var/ext/bin:$PATH
EOF

echo "Deleting pyc and pyo files..."
find /opt/zenoss -name \*.py[co] -delete
